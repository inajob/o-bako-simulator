<html>
<head>
  <title>o-bako Simulator</title>
  <style>
    body{
      background-color: black;
      color: white;
    }
    canvas#original{
      display: none;
    }
    canvas{
      border: solid #383;
    }
    #controller{
      text-align:center;
    }
    #error{
      color: red;
      background-color:white;
    }
    #editor{
      height: 384px;
      width: calc(100% - 400px);
      background-color: black;
      color: #ddd;
    }
    #sprite{
      border: solid #383;
    }
    table td{
      border: solid 1px #383;
    }
    .pad{
      margin:2em;
      padding:1em;
      background-color: #383;
    }
    a{
      color: #fff;
    }
  </style>
  <script src="js/fengari-web.js" type="text/javascript"></script>
  <script type="text/javascript">
    const KEY_UP = 38;
    const KEY_DOWN = 40;
    const KEY_LEFT = 37;
    const KEY_RIGHT = 39;
    const KEY_START_BTN = 65; // a
    const KEY_A_BTN = 90; // z
    const KEY_B_BTN = 88; // x

    const size = 128;
    const zoom = 3;
    let buttonState = [0,0,0,0,0,0,0];
    let buttonTrig =  [0,0,0,0,0,0,0];
    let spriteImage;

    window.addEventListener("keyup",function(e){
      switch(e.keyCode){
        case KEY_UP: buttonState[2] = 0; break;
        case KEY_DOWN: buttonState[3] = 0; break;
        case KEY_LEFT: buttonState[0] = 0; break;
        case KEY_RIGHT: buttonState[1] = 0; break;
        case KEY_START_BTN: buttonState[4] = 0; break;
        case KEY_A_BTN: buttonState[5] = 0; break;
        case KEY_B_BTN: buttonState[6] = 0; break;
      }
    });
    window.addEventListener("keydown",function(e){
      switch(e.keyCode){
        case KEY_UP: buttonState[2] = 1; break;
        case KEY_DOWN: buttonState[3] = 1; break;
        case KEY_LEFT: buttonState[0] = 1; break;
        case KEY_RIGHT: buttonState[1] = 1; break;
        case KEY_START_BTN: buttonState[4] = 1; break;
        case KEY_A_BTN: buttonState[5] = 1; break;
        case KEY_B_BTN: buttonState[6] = 1; break;
      }
      if(document.activeElement != document.getElementById("editor"))
      e.preventDefault();
      return false;
    });

    var osc= [];
    var gain= [];
    function initTones(){
      // init tones
      // osc -- gain -+
      // osc -- gain -+
      // osc -- gain -+- destination
      let actx = new window.AudioContext();
      for(let i = 0; i < 3; i ++){
        osc[i] = actx.createOscillator();
        osc[i].type = 'sine';
        osc[i].frequency.value = 440 + 100*i;

        gain[i] = actx.createGain();
        osc[i].connect(gain[i]);
        gain[i].gain.value = 0.00;
        gain[i].connect(actx.destination);
        osc[i].start();
      }

    }

    function initLua(ctx){
      const L = fengari.lauxlib.luaL_newstate();
      fengari.lualib.luaL_openlibs(L);
      let canvasState = {color: [0,0,0]};

      // register functions
      fengari.lua.lua_register(L, "tone", function(){
        const n = fengari.lua.lua_tointeger(L, 1);
        const f = fengari.lua.lua_tointeger(L, 2);
        const v = fengari.lua.lua_tointeger(L, 3);

        osc[n].frequency.value = f;
        gain[n].gain.value = (v/255);
        return 0;
      });

      fengari.lua.lua_register(L, "spr", function(){
        const x = fengari.lua.lua_tointeger(L, 1);
        const y = fengari.lua.lua_tointeger(L, 2);
        const w = fengari.lua.lua_tointeger(L, 3);
        const h = fengari.lua.lua_tointeger(L, 4);
        const sx = fengari.lua.lua_tointeger(L, 5);
        const sy = fengari.lua.lua_tointeger(L, 6);
        const sw = fengari.lua.lua_tointeger(L, 7);
        const sh = fengari.lua.lua_tointeger(L, 8);

        ctx.drawImage(spriteImage, sx, sy, sw, sh, x, y, w, h);
        return 0;
      });


      fengari.lua.lua_register(L, "color", function(){
        const r = fengari.lua.lua_tointeger(L, 1);
        const g = fengari.lua.lua_tointeger(L, 2);
        const b = fengari.lua.lua_tointeger(L, 3);

        canvasState.color = [r, g, b];
        ctx.fillStyle = "rgb(" + [r,g,b].join(",") + ")"
        ctx.strokeStyle = "rgb(" + [r,g,b].join(",") + ")"
        return 0;
      });

      fengari.lua.lua_register(L, "text", function(){
        const s = fengari.lua.lua_tostring(L, 1);
        const x = fengari.lua.lua_tointeger(L, 2);
        const y = fengari.lua.lua_tointeger(L, 3);
        const ss = fengari.to_jsstring(s);
        ctx.fillText(ss, x, y + 8);
        return 0;
      });

      fengari.lua.lua_register(L, "pset", function(){
        const x = fengari.lua.lua_tointeger(L, 1);
        const y = fengari.lua.lua_tointeger(L, 2);
        ctx.fillRect(x, y, 1, 1);
        return 0;
      });

      fengari.lua.lua_register(L, "line", function(){
        const x = fengari.lua.lua_tointeger(L, 1);
        const y = fengari.lua.lua_tointeger(L, 2);
        const x2 = fengari.lua.lua_tointeger(L, 3);
        const y2 = fengari.lua.lua_tointeger(L, 4);
        ctx.beginPath();
        ctx.moveTo(x,y);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        return 0;
      });

      fengari.lua.lua_register(L, "drawrect", function(){
        const x = fengari.lua.lua_tointeger(L, 1);
        const y = fengari.lua.lua_tointeger(L, 2);
        const w = fengari.lua.lua_tointeger(L, 3);
        const h = fengari.lua.lua_tointeger(L, 4);
        ctx.beginPath();
        ctx.rect(x, y, w, h);
        ctx.stroke();
        return 0;
      });

      fengari.lua.lua_register(L, "fillrect", function(){
        const x = fengari.lua.lua_tointeger(L, 1);
        const y = fengari.lua.lua_tointeger(L, 2);
        const w = fengari.lua.lua_tointeger(L, 3);
        const h = fengari.lua.lua_tointeger(L, 4);
        ctx.beginPath();
        ctx.rect(x, y, w, h);
        ctx.fill();
        return 0;
      });

      fengari.lua.lua_register(L, "drawcircle", function(){
        const x = fengari.lua.lua_tointeger(L, 1);
        const y = fengari.lua.lua_tointeger(L, 2);
        const r = fengari.lua.lua_tointeger(L, 3);
        ctx.beginPath();
        ctx.arc(x, y, r, 0, 2 * Math.PI);
        ctx.stroke();
        return 0;
      });

      fengari.lua.lua_register(L, "fillcircle", function(){
        const x = fengari.lua.lua_tointeger(L, 1);
        const y = fengari.lua.lua_tointeger(L, 2);
        const r = fengari.lua.lua_tointeger(L, 3);
        ctx.beginPath();
        ctx.arc(x, y, r, 0, 2 * Math.PI);
        ctx.fill();
        return 0;
      });


      fengari.lua.lua_register(L, "btn", function(){
        const n = fengari.lua.lua_tointeger(L, 1);
        fengari.lua.lua_pushnumber(L, buttonTrig[n]);
        return 1;
      });
      return L;
    }

    let timer = null;

    function runGame(L, s, c, ctxm, errf){
      let ret = fengari.lauxlib.luaL_dostring(L, s);
      if(ret != 0){
        errf(fengari.to_jsstring(fengari.lua.lua_tostring(L, -1)));
        return;
      }

      fengari.lua.lua_getglobal(L, "setup");
      ret = fengari.lua.lua_call(L, 0, 0);
      if(ret == 0){
        errf(fengari.to_jsstring(fengari.lua.lua_tostring(L, -1)));
        return;
      }
      function next(t){
        let d = (new Date).getTime();
        timer = setTimeout(function(){
          timer = null;
          fengari.lua.lua_getglobal(L, "loop");
          ret = fengari.lua.lua_call(L, 0, 0);
          if(ret == 0){
            errf(fengari.to_jsstring(fengari.lua.lua_tostring(L, -1)));
            return;
          }

          let now = (new Date).getTime();

          for(let i = 0; i < buttonState.length; i ++){
            if(buttonTrig[i] == -1){
              buttonTrig[i] = 0;
            }
            if(buttonState[i] == 1){
              buttonTrig[i] ++;
            }else{
              buttonTrig[i] = -1;
            }
          }
          ctxm.drawImage(c, 0, 0, size*zoom, size*zoom)

          next(1000/30 - (now - d));
        }, t);
      }
      next(1000/30);
    }

    window.onload= function(){
      const errElm = document.getElementById("error");

      // init canvas
      spriteImage = document.getElementById("sprite");
      const c = document.getElementById("original");
      c.width = size;
      c.height = size;

      const ctx = c.getContext("2d");
      ctx.imageSmoothingEnabled = false;
      ctx.translate(0.5, 0.5);
      ctx.font = "11px 'ＭＳ ゴシック'";

      const m = document.getElementById("main");
      m.width = size * zoom;
      m.height = size * zoom;

      const ctxm = m.getContext("2d");
      ctxm.imageSmoothingEnabled = false;

      initTones();
      let L;

      function clearErr(){
        errElm.innerHTML = "";
      }
      function errf(s){
        errElm.appendChild(document.createTextNode(s));
      }

      const runButton = document.getElementById("runbtn");
      function execute(){
        if(timer){
          clearTimeout(timer);
        }
        clearErr();
        const editor = document.getElementById("editor");
        L = initLua(ctx);
        const str = fengari.to_luastring(editor.value);

        runGame(L, str, c, ctxm, errf);
      }
      runButton.addEventListener("click", function(e){
        execute();
      });
      execute();


    }
  </script>
</head>
<body>
<a href="https://github.com/inajob/o-bako-simulator"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a>
  <h1>o-bako Simulator</h1>
  <canvas id="original"></canvas>
  <canvas id="main"></canvas>
  <textarea id="editor">
function setup()
end

count = 0
M_TITLE = 0
M_GAME = 1
mode = M_TITLE
counter = 0

function loop()
  if mode == M_TITLE then
    mode = do_title()
  elseif mode == M_GAME then
    mode = do_game()
  end
  counter = counter + 1
end

function do_title()
  color(0,0,0)
  fillrect(0,0, 128, 128)
  color(255, 255, 255)
  text("SAMLE GAME", 0, 0)
  if math.floor(counter/30)%2 == 0 then
    color(0,0,0)
  else
    color(255,255,255)
  end
  text("PRESS START", 30, 60)

  if btn(4) == 1 then
    return M_GAME
  end
  return M_TITLE
end

x = 0
y = 0

function do_game()
  color(0, 0, 0)
  fillrect(0, 0, 128, 128)
  spr(x, y, 16, 16, 0, 0, 16, 16)
  if btn(0) > 0 then
    x = x - 1
  end
  if btn(1) > 0 then
    x = x + 1
  end
  if btn(2) > 0 then
    y = y - 1
  end
  if btn(3) > 0 then
    y = y + 1
  end

  return M_GAME
end

  </textarea>
  <div id="controller">
    <input id="runbtn" type="button" value="Execute" />
  </div>
  <div id="error">
  </div>
  <div class="pad">
o-bakoのシミュレータです。(o-bakoはまだ開発中です）
Lua言語で記述します。起動時にsetup()が1度呼ばれその後30FPSの間隔でloop()が呼ばれます。

スプライトについては、下記spriteの画像が参照できます。別の画像を参照したい場合は、このプロジェクトをforkして好きに書き換えてください。
  </div>
  <div class="pad">
This is the simulator of o-bako.(o-bako is under construction.)
You can write program with Lua. When boot time, o-bako call `setup()`. Then call `loop()` every 30FPS.

You can only use the sprite image below. If you want to use another image, feel free to fork this repository and modify the image.
  </div>
  <div>created by <a href="http://twitter.com/ina_ani" target="_blank">@ina_ani</a></div>
  <div>
  <h2>Button mapping</h2>
  <table>
    <tr><td>0</td><td>LEFT</td></tr>
    <tr><td>1</td><td>RIGHT</td></tr>
    <tr><td>2</td><td>UP</td></tr>
    <tr><td>3</td><td>DOWN</td></tr>
    <tr><td>4</td><td>StartButton (A)</td></tr>
    <tr><td>5</td><td>1Button (Z)</td></tr>
    <tr><td>6</td><td>2Button (X)</td></tr>
  </table>
  </div>
  <div>
  <h2>Sprite</h2>
  <img id="sprite" src="sprite.bmp" />
  </div>
  <div>
  <h2>Specification</h2>
  <table>
    <tr><td>resolution</td><td>128*128 full color</td></tr>
    <tr><td>interface</td><td>d-pad + A,B button + Start button</td></tr>
    <tr><td>sound</td><td>3 tones generator</td></tr>
  </table>
  <h2>Reference</h2>
  <table>
  <tr>
    <td>tone(no, freq, vol)</td>
    <td>音を鳴らす(no: 0-2, vol: 0-255)</td>
    <td>Generate tone(no: 0-2, vol: 0-255)</td>
  </tr>
  <tr>
    <td>spr(x,y,w,h,sx,sy)</td>
    <td>(x,y)にspriteを(sx,sy)から描画する。サイズはw,h</td>
    <td>draw sprite to (x,y) from (sx, sy) with the size w,h</td>
  </tr>
  <tr>
    <td>pset(x,y)</td>
    <td>(x,y)に1ピクセルのドットを描画</td>
    <td>draw pixel at (x,y)</td>
  </tr>
  <tr>
    <td>color(r,g,b)</td>
    <td>ペンの色を[r,g,b]に設定。(r: 0-255, g: 0-255, b: 0-255)</td>
    <td>set pen color [r,g,b] (r: 0-255, g: 0-255, b: 0-255)</td>
  </tr>
  <tr>
    <td>text(s,x,y)</td>
    <td>(x,y)に文字列sを描画</td>
    <td>draw string s to (x,y)</td>
  </tr>
  <tr>
    <td>drawrect(x,y,w,h)</td>
    <td>(x,y)にサイズw,hの四角形の枠線を描画</td>
    <td>draw rectanble (x,y) with the size w,h</td>
  </tr>
  <tr>
    <td>fillrect(x,y,w,h)</td>
    <td>(x,y)にサイズw,hの四角形を塗りつぶす</td>
    <td>fill rectanble (x,y) with the size w,h</td>
  </tr>
  <tr>
    <td>fillcircle(x,y,r)</td>
    <td>(x,y)を中心に半径rの円を塗りつぶす</td>
    <td>fill circle at (x,y) with radius r</td>
  </tr>
  <tr>
    <td>btn(n)</td>
    <td>ボタンの入力を取得 ボタンを押してからのフレーム数が返る</td>
    <td>get button input. returns frame count while press button.</td>
  </tr>
  <tr>
    <td>getip()</td>
    <td>IPアドレスを取得（未実装）</td>
    <td>get IP address (not implement)</td>
  </tr>
  <tr>
    <td>iswifidebug()</td>
    <td>WiFiがオンになっているかを取得（未実装）</td>
    <td>get whether WiFi on(not implement)</td>
  </tr>
  <tr>
    <td>wifiserve()</td>
    <td>WiFiをオンにする（未実装）</td>
    <td>turn on WiFi(not implement)</td>
  </tr>
  <tr>
    <td>run(file)</td>
    <td>fileを実行（未実装）</td>
    <td>run file (not implement)</td>
  </tr>
  <tr>
    <td>list()</td>
    <td>ファイル一覧を取得（未実装）</td>
    <td>get file list (not implement)</td>
  </tr>
  <tr>
    <td>reboot()</td>
    <td>端末のリブート（未実装）</td>
    <td>reboot machine (not implement)</td>
  </tr>
  </table>
  </div>
  <hr>
  <div>created by <a href="http://twitter.com/ina_ani" target="_blank">@ina_ani</a></div>
</body>
</html>
